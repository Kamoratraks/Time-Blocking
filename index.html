<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Sectograph (Google Sync)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #eef2f5;
            --text-color: #333;
            --clock-bg: #ffffff;
            --primary-btn: #4285F4;
        }
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background: var(--clock-bg);
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            padding: 30px;
            width: 100%;
            max-width: 450px;
            text-align: center;
            position: relative;
        }
        
        /* Header & Date */
        h2 { margin: 0; color: var(--text-color); font-size: 1.5rem; }
        .date-sub { color: #888; margin-bottom: 20px; font-size: 0.9rem; margin-top: 5px; }

        /* Button Style */
        .btn-auth {
            background-color: var(--primary-btn);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-family: 'Sarabun', sans-serif;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3);
            transition: all 0.2s;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-auth:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(66, 133, 244, 0.4); }
        .btn-signout { background-color: #ff5252; box-shadow: 0 4px 10px rgba(255, 82, 82, 0.3); }
        .hidden { display: none !important; }

        /* Clock Wrapper */
        .clock-wrapper {
            position: relative;
            width: 320px;
            height: 320px;
            margin: 0 auto 30px auto;
        }
        canvas {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        .center-dial {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100px; height: 100px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        #time-display { font-size: 1.6rem; font-weight: bold; color: #333; margin: 0;}
        .center-dial small { color: #999; font-size: 0.7rem; }

        /* Schedule List */
        .schedule-list { text-align: left; max-height: 300px; overflow-y: auto; }
        .schedule-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 5px solid #ccc;
            transition: 0.2s;
        }
        .time-range { font-weight: bold; font-size: 0.85rem; margin-right: 15px; min-width: 85px; color: #555; }
        .task-name { flex-grow: 1; font-weight: 600; font-size: 0.95rem; }
    </style>
</head>
<body>

<div class="container">
    <h2 id="day-display">My Schedule</h2>
    <div class="date-sub" id="date-display">...</div>

    <button id="auth_btn" class="btn-auth" onclick="handleAuthClick()">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.64 9.2c0-.63-.06-1.25-.16-1.84H9v3.48h4.84a4.14 4.14 0 0 1-1.8 2.71v2.26h2.92c1.71-1.57 2.68-3.89 2.68-6.61z" fill="#4285F4"/><path d="M9 18c2.43 0 4.47-.8 5.96-2.18l-2.9-2.26c-.8.54-1.83.86-3.05.86-2.35 0-4.34-1.59-5.06-3.73H1.85v2.33C3.33 15.93 5.99 18 9 18z" fill="#34A853"/><path d="M3.94 10.69A5.36 5.36 0 0 1 3.66 9c0-.58.1-1.15.28-1.69V4.98H1.85A8.99 8.99 0 0 0 0 9c0 1.45.35 2.82.96 4.04l2.98-2.35z" fill="#FBBC05"/><path d="M9 3.58c1.32 0 2.5.45 3.44 1.35l2.58-2.58C13.47.89 11.43 0 9 0 5.99 0 3.33 2.07 1.85 4.98l2.97 2.33c.71-2.14 2.7-3.73 5.06-3.73z" fill="#EA4335"/></svg>
        ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Calendar
    </button>
    <button id="signout_btn" class="btn-auth btn-signout hidden" onclick="handleSignoutClick()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>

    <div class="clock-wrapper">
        <canvas id="clockCanvas" width="640" height="640"></canvas>
        <div class="center-dial">
            <h1 id="time-display">--:--</h1>
            <small>Now</small>
        </div>
    </div>

    <div class="schedule-list" id="scheduleList">
        <div style="text-align:center; color:#999; margin-top:20px;">
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </div>
    </div>
</div>

<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

<script>
    // ==========================================
    // üî¥ ‡πÉ‡∏™‡πà KEY ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üî¥
    // ==========================================
    const CLIENT_ID = '403729551714-j8jksjp2uqoauhc7bi2ibh02bpnvtvbh.apps.googleusercontent.com'; 
    const API_KEY = 'AIzaSyC9B9m47khLErMibHa0Fjc29B2xxE8Osoo';
    // ==========================================

    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/calendar.events.readonly';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let mySchedule = []; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ß‡∏≤‡∏î

    // --- Authentication ---
    function gapiLoaded() {
        gapi.load('client', async () => {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC], });
            gapiInited = true; checkAuth();
        });
    }
    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES, callback: '',
        });
        gisInited = true; checkAuth();
    }
    function checkAuth() {
        if (gapiInited && gisInited) {
            // ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏£‡∏≠‡∏Ñ‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°)
        }
    }
    function handleAuthClick() {
        tokenClient.callback = async (resp) => {
            if (resp.error) throw resp;
            updateUIState(true);
            await fetchEvents(); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
        };
        if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'});
        else tokenClient.requestAccessToken({prompt: ''});
    }
    function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
            google.accounts.oauth2.revoke(token.access_token);
            gapi.client.setToken('');
            updateUIState(false);
            mySchedule = [];
            drawClock();
            document.getElementById('scheduleList').innerHTML = '<div style="text-align:center; color:#999; margin-top:20px;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß</div>';
        }
    }
    function updateUIState(isSignedIn) {
        if (isSignedIn) {
            document.getElementById('auth_btn').classList.add('hidden');
            document.getElementById('signout_btn').classList.remove('hidden');
        } else {
            document.getElementById('auth_btn').classList.remove('hidden');
            document.getElementById('signout_btn').classList.add('hidden');
        }
    }

    // --- Google Calendar Fetching ---
    async function fetchEvents() {
        const now = new Date();
        const startOfDay = new Date(now.setHours(0,0,0,0)).toISOString();
        const endOfDay = new Date(now.setHours(23,59,59,999)).toISOString();

        try {
            const request = {
                'calendarId': 'primary',
                'timeMin': startOfDay,
                'timeMax': endOfDay,
                'showDeleted': false,
                'singleEvents': true,
                'orderBy': 'startTime',
            };
            const response = await gapi.client.calendar.events.list(request);
            const events = response.result.items;
            
            // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å‡πÄ‡∏£‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à
            mySchedule = events
                .filter(ev => ev.start.dateTime) // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Event ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°-‡∏à‡∏ö (‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤ All day)
                .map((ev, index) => {
                    const start = new Date(ev.start.dateTime);
                    const end = new Date(ev.end.dateTime);
                    const startStr = start.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
                    const endStr = end.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
                    
                    // ‡∏™‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏™‡∏ß‡∏¢‡πÜ ‡∏ñ‡πâ‡∏≤ Google ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
                    const palette = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#FFA07A", "#96CEB4", "#D4A5A5", "#9B59B6"];
                    const color = palette[index % palette.length];

                    return {
                        name: ev.summary || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)",
                        start: startStr,
                        end: endStr,
                        startTimeObj: start, // ‡πÄ‡∏Å‡πá‡∏ö object ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏ß‡πâ‡∏ß‡∏≤‡∏î
                        endTimeObj: end,
                        color: color
                    };
                });

            renderList(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
            drawClock();  // ‡∏ß‡∏≤‡∏î‡∏ß‡∏á‡∏Å‡∏•‡∏°

        } catch (err) {
            console.error(err);
            alert('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
        }
    }

    // --- Graphic / Drawing Logic (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢) ---
    const canvas = document.getElementById('clockCanvas');
    const ctx = canvas.getContext('2d');
    const cx = canvas.width / 2;
    const cy = canvas.height / 2;
    const radius = 280;

    function timeToAngle(dateObj) {
        const h = dateObj.getHours() % 12; // ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏î 12 ‡∏ä‡∏°.
        const m = dateObj.getMinutes();
        const totalMins = (h * 60) + m;
        return (totalMins / 720) * (2 * Math.PI);
    }

    function drawClock() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. ‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
        ctx.beginPath(); ctx.arc(cx, cy, radius, 0, 2 * Math.PI);
        ctx.fillStyle = '#f0f0f0'; ctx.fill();

        // 2. ‡∏ß‡∏≤‡∏î Events
        mySchedule.forEach(task => {
            let startAngle = timeToAngle(task.startTimeObj);
            let endAngle = timeToAngle(task.endTimeObj);

            if (endAngle < startAngle) endAngle += 2 * Math.PI; // ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á

            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.arc(cx, cy, radius, startAngle, endAngle);
            ctx.closePath();

            // Gradient ‡∏™‡∏µ
            let gradient = ctx.createRadialGradient(cx, cy, radius*0.5, cx, cy, radius);
            gradient.addColorStop(0, task.color);
            gradient.addColorStop(1, adjustColor(task.color, -30));

            ctx.fillStyle = gradient;
            ctx.fill();
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 4; ctx.stroke();
        });

        // 3. ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏µ‡∏î‡πÄ‡∏ß‡∏•‡∏≤
        for(let i=0; i<12; i++) {
            let angle = (i/12) * 2 * Math.PI;
            ctx.beginPath();
            ctx.moveTo(cx + Math.cos(angle)*(radius-15), cy + Math.sin(angle)*(radius-15));
            ctx.lineTo(cx + Math.cos(angle)*radius, cy + Math.sin(angle)*radius);
            ctx.strokeStyle = '#bbb';
            ctx.lineWidth = (i%3===0) ? 4 : 2;
            ctx.stroke();
        }

        // 4. ‡πÄ‡∏Ç‡πá‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        const now = new Date();
        const nowH = now.getHours() % 12;
        const nowM = now.getMinutes();
        const nowAngle = ((nowH*60 + nowM) / 720) * 2 * Math.PI;

        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, radius + 15, nowAngle - 0.03, nowAngle + 0.03); // ‡πÄ‡∏Ç‡πá‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡πá‡∏Å‡πÜ‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏ö
        ctx.strokeStyle = '#ff3b30';
        ctx.lineWidth = 6;
        ctx.stroke();
    }

    // --- Helper Functions ---
    function renderList() {
        const listContainer = document.getElementById('scheduleList');
        if (mySchedule.length === 0) {
            listContainer.innerHTML = '<div style="text-align:center; padding:20px;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>';
            return;
        }
        let html = '';
        mySchedule.forEach(task => {
            html += `
                <div class="schedule-item" style="border-left-color: ${task.color}">
                    <div class="time-range" style="color:${task.color}">${task.start} - ${task.end}</div>
                    <div class="task-name">${task.name}</div>
                </div>`;
        });
        listContainer.innerHTML = html;
    }

    function adjustColor(color, amount) {
        return '#' + color.replace(/^#/, '').replace(/../g, color => ('0'+Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));
    }

    function updateRealTime() {
        const now = new Date();
        document.getElementById('time-display').innerText = now.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
        document.getElementById('day-display').innerText = now.toLocaleDateString('en-US', {weekday: 'long'});
        document.getElementById('date-display').innerText = now.toLocaleDateString('th-TH', {day: 'numeric', month: 'long', year: 'numeric'});
        drawClock();
    }

    setInterval(updateRealTime, 1000);
    updateRealTime();

</script>
</body>
</html>
