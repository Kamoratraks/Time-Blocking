<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sectograph Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #4e54c8;
            --secondary: #8f94fb;
            --task-color: #ff6b6b;
            --bg: #f4f7fc;
            --card-bg: #ffffff;
            --text-main: #333;
            --text-muted: #888;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        body {
            font-family: 'Prompt', sans-serif;
            background: var(--bg);
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .app-container {
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            background: var(--card-bg);
            border-radius: 30px;
            box-shadow: var(--shadow);
            display: flex;
            overflow: hidden;
            position: relative;
            transition: 0.3s;
        }

        /* --- Sidebar (‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) --- */
        .sidebar {
            width: 400px;
            background: #fafbff;
            border-right: 1px solid #eee;
            padding: 25px;
            display: flex;
            flex-direction: column;
            z-index: 10;
            transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* ‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö (Handle) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        .mobile-handle {
            display: none;
            width: 50px; height: 6px;
            background: #e0e0e0;
            border-radius: 10px;
            margin: -10px auto 15px auto;
        }

        .header { margin-bottom: 20px; flex-shrink: 0; }
        .header h1 { margin: 0; font-size: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .header p { margin: 5px 0 0; color: var(--text-muted); font-size: 0.9rem; }

        .tabs {
            display: flex; background: #eef2f7; padding: 5px; border-radius: 12px; margin-bottom: 15px; flex-shrink: 0;
        }
        .tab-btn {
            flex: 1; padding: 10px; border: none; background: transparent; color: var(--text-muted);
            border-radius: 8px; cursor: pointer; font-family: 'Prompt'; font-weight: 500; transition: 0.3s;
        }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: 600; }

        .content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 5px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .list-section { display: none; animation: fadeIn 0.3s ease; }
        .list-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Items */
        .task-item, .todo-item {
            background: white; padding: 12px 15px; border-radius: 12px; margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); transition: 0.2s; position: relative; overflow: hidden;
        }
        .task-item { border-left: 5px solid #ddd; }
        /* Active Glow Animation for List Item */
        .task-item.active-now {
            background: #f0f7ff;
            border-left-width: 8px;
            box-shadow: 0 4px 12px rgba(78, 84, 200, 0.15);
        }
        .task-item.active-now::after {
            content: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡∏π‡πà'; position: absolute; top: 12px; right: 15px;
            font-size: 0.7rem; color: var(--primary); font-weight: bold;
            background: rgba(78, 84, 200, 0.1); padding: 2px 8px; border-radius: 10px;
        }

        .todo-item { border-left: 5px solid var(--task-color); display: flex; align-items: center; gap: 12px; }
        .task-time { font-size: 0.8rem; color: var(--text-muted); font-weight: 600; display: flex; align-items: center; gap: 5px;}
        .task-title { font-size: 1rem; margin-top: 3px; font-weight: 500; color: var(--text-main); }
        .todo-check { width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; cursor: pointer; flex-shrink: 0; }
        .todo-check:hover { border-color: var(--task-color); }
        .todo-content { flex-grow: 1; }
        .todo-title { font-size: 0.95rem; font-weight: 500; }
        .todo-due { font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 4px; margin-top: 2px; }

        /* --- Main Clock --- */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: radial-gradient(circle at center, #ffffff 0%, #f8f9fa 100%);
            transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .clock-wrapper { position: relative; width: 500px; height: 500px; transition: 0.4s; }
        canvas { width: 100%; height: 100%; }
        
        .center-info {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none; transition: 0.3s;
        }
        .time-big { font-size: 3.5rem; font-weight: 600; color: var(--primary); margin: 0; line-height: 1;}
        .date-small { font-size: 1rem; color: #999; margin-top: 5px; }

        .btn-login {
            background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; border: none;
            padding: 12px; border-radius: 12px; cursor: pointer; font-family: inherit; font-weight: 600;
            display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; margin-bottom: 20px; transition: 0.3s;
        }
        .btn-logout { background: #ff6b6b; margin-top: 10px; }
        .fab {
            position: absolute; bottom: 30px; right: 30px; width: 60px; height: 60px;
            background: var(--primary); color: white; border-radius: 50%; border: none; font-size: 24px;
            cursor: pointer; box-shadow: 0 10px 20px rgba(78, 84, 200, 0.4); display: none; z-index: 100; transition: 0.3s;
        }
        .fab:hover { transform: scale(1.1) rotate(90deg); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 350px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; font-family: 'Prompt'; }
        .btn-save { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-size: 1rem;}
        .close-modal { float: right; cursor: pointer; color: #999; font-size: 1.2rem;}

        /* --- üì± Mobile Optimization --- */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; height: 100vh; width: 100%; border-radius: 0; overflow: hidden; }
            .mobile-handle { display: block; }
            
            .main-content { height: 45%; width: 100%; padding-top: 20px; box-sizing: border-box; }
            .clock-wrapper { width: 280px; height: 280px; }
            .time-big { font-size: 2.5rem; }

            .sidebar { 
                width: 100%; height: 55%; border-right: none; border-top: 1px solid #eee;
                border-radius: 25px 25px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
                position: relative; padding-top: 15px;
            }

            /* ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */
            body.clock-shrunk .main-content { height: 30%; } 
            body.clock-shrunk .clock-wrapper { transform: scale(0.65); margin-top: -20px; }
            body.clock-shrunk .center-info { opacity: 0; }
            body.clock-shrunk .sidebar { height: 70%; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="mobile-handle"></div> <div class="header">
                <h1><i class="fas fa-clock"></i> Planner Pro</h1>
                <p id="user-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö...</p>
            </div>
            <button id="authBtn" class="btn-login" onclick="handleAuth()">
                <i class="fab fa-google"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
            </button>
            <div class="tabs" id="tabContainer" style="display:none;">
                <button class="tab-btn active" onclick="switchTab('events')">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</button>
                <button class="tab-btn" onclick="switchTab('tasks')">Tasks</button>
            </div>

            <div class="content-area" id="contentArea">
                <div class="list-section active" id="eventListSection">
                    <div id="eventList"><div style="text-align:center; color:#ccc; margin-top:40px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div></div>
                </div>
                <div class="list-section" id="taskListSection">
                    <div id="taskList"><div style="text-align:center; color:#ccc; margin-top:40px;">‡πÑ‡∏°‡πà‡∏°‡∏µ Tasks</div></div>
                </div>
                <div style="height: 100px;"></div> </div>

            <button id="logoutBtn" class="btn-login btn-logout" onclick="handleSignout()" style="display:none;">
                ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>

        <div class="main-content">
            <div class="clock-wrapper">
                <canvas id="clock" width="1000" height="1000"></canvas>
                <div class="center-info">
                    <h1 class="time-big" id="currentTime">--:--</h1>
                    <div class="date-small" id="currentDate">...</div>
                </div>
            </div>
            <button class="fab" id="addBtn" onclick="openModal()">+</button>
        </div>
    </div>

    <div class="modal" id="eventModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 style="margin-top:0;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h2>
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</label> <input type="text" id="eventTitle" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°, ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢">
            <label>‡πÄ‡∏£‡∏¥‡πà‡∏°:</label> <input type="datetime-local" id="eventStart" class="form-control">
            <label>‡∏à‡∏ö:</label> <input type="datetime-local" id="eventEnd" class="form-control">
            <button class="btn-save" onclick="saveEvent()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
    </div>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        // ==========================================
        // üîê KEY ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        // ==========================================
        const CLIENT_ID = '403729551714-j8jksjp2uqoauhc7bi2ibh02bpnvtvbh.apps.googleusercontent.com'; 
        const API_KEY = 'AIzaSyC9B9m47khLErMibHa0Fjc29B2xxE8Osoo';
        // ==========================================

        const DISCOVERY_DOCS = [
            'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
            'https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest'
        ];
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/tasks'; 

        let tokenClient, gapiInited = false, gisInited = false;
        let myEvents = [], myTasks = [];

        // --- Helper: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ (‡∏Ç‡∏≤‡∏ß/‡∏î‡∏≥) ---
        function getContrastColor(hexColor) {
            // ‡πÅ‡∏õ‡∏•‡∏á Hex ‡πÄ‡∏õ‡πá‡∏ô RGB
            const r = parseInt(hexColor.substr(1, 2), 16);
            const g = parseInt(hexColor.substr(3, 2), 16);
            const b = parseInt(hexColor.substr(5, 2), 16);
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á (Luminance)
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#333333' : '#ffffff'; // ‡∏ñ‡πâ‡∏≤‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏î‡∏≥ ‡∏ñ‡πâ‡∏≤‡∏°‡∏∑‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≤‡∏ß
        }

        // --- Mobile Scroll Logic ---
        const contentArea = document.getElementById('contentArea');
        contentArea.addEventListener('scroll', () => {
            if (window.innerWidth <= 768) {
                if (contentArea.scrollTop > 20) {
                    document.body.classList.add('clock-shrunk');
                } else {
                    document.body.classList.remove('clock-shrunk');
                }
            }
        });

        function gapiLoaded() {
            gapi.load('client', async () => {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
                gapiInited = true; checkAutoLogin();
            });
        }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES, callback: '', 
            });
            gisInited = true; checkAutoLogin();
        }

        function checkAutoLogin() {
            const savedToken = localStorage.getItem('g_token_pro_ult');
            if (savedToken && gapiInited && gisInited) {
                try {
                    gapi.client.setToken(JSON.parse(savedToken));
                    toggleState(true);
                    fetchAllData();
                } catch(e) {}
            } else { toggleState(false); }
        }

        function handleAuth() {
            tokenClient.callback = async (resp) => {
                if (resp.error) throw resp;
                localStorage.setItem('g_token_pro_ult', JSON.stringify(gapi.client.getToken()));
                toggleState(true);
                await fetchAllData();
            };
            if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'});
            else tokenClient.requestAccessToken({prompt: ''});
        }

        function handleSignout() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                localStorage.removeItem('g_token_pro_ult');
            }
            toggleState(false);
            myEvents = []; myTasks = [];
            drawClock(); renderUI();
        }

        function toggleState(isLoggedIn) {
            const authBtn = document.getElementById('authBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const addBtn = document.getElementById('addBtn');
            const userStatus = document.getElementById('user-status');
            const tabContainer = document.getElementById('tabContainer');

            if (isLoggedIn) {
                authBtn.style.display = 'none'; logoutBtn.style.display = 'block';
                addBtn.style.display = 'block'; tabContainer.style.display = 'flex';
                userStatus.innerText = "‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå"; userStatus.style.color = "green";
            } else {
                authBtn.style.display = 'flex'; logoutBtn.style.display = 'none';
                addBtn.style.display = 'none'; tabContainer.style.display = 'none';
                userStatus.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠"; userStatus.style.color = "#888";
            }
        }

        async function fetchAllData() { await fetchEvents(); await fetchTasks(); }

        async function fetchEvents() {
            try {
                const now = new Date();
                const startOfDay = new Date(now.setHours(0,0,0,0)).toISOString();
                const endOfDay = new Date(now.setHours(23,59,59,999)).toISOString();
                const response = await gapi.client.calendar.events.list({
                    'calendarId': 'primary', 'timeMin': startOfDay, 'timeMax': endOfDay,
                    'showDeleted': false, 'singleEvents': true, 'orderBy': 'startTime'
                });
                myEvents = response.result.items || [];
                renderUI();
            } catch (err) { if(err.status===401) handleSignout(); }
        }

        async function fetchTasks() {
            try {
                const response = await gapi.client.tasks.tasks.list({
                    'tasklist': '@default', 'showCompleted': false, 'maxResults': 30
                });
                myTasks = response.result.items || [];
                renderUI();
            } catch (err) { }
        }

        async function saveEvent() {
            const summary = document.getElementById('eventTitle').value;
            const startVal = document.getElementById('eventStart').value;
            const endVal = document.getElementById('eventEnd').value;
            if(!summary || !startVal || !endVal) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            const event = {
                'summary': summary,
                'start': { 'dateTime': new Date(startVal).toISOString() },
                'end': { 'dateTime': new Date(endVal).toISOString() }
            };
            try {
                await gapi.client.calendar.events.insert({ 'calendarId': 'primary', 'resource': event });
                closeModal(); alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!"); fetchAllData();
            } catch (err) { alert("Error: " + err.message); }
        }

        function renderUI() { renderEventList(); renderTaskList(); drawClock(); }

        function renderEventList() {
            const list = document.getElementById('eventList');
            const now = new Date();
            list.innerHTML = '';
            if (myEvents.length === 0) { list.innerHTML = '<div style="text-align:center;color:#ccc;margin-top:20px;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>'; return; }
            myEvents.forEach((ev, idx) => {
                if(!ev.start.dateTime) return;
                const start = new Date(ev.start.dateTime);
                const end = new Date(ev.end.dateTime);
                
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°?
                const isActive = now >= start && now <= end;
                const activeClass = isActive ? 'active-now' : '';

                const timeStr = `${start.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})} - ${end.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})}`;
                const color = ev.colorId ? '#4e54c8' : `hsl(${idx*60}, 60%, 60%)`;
                
                list.innerHTML += `
                    <div class="task-item ${activeClass}" style="border-left-color:${color}">
                        <div class="task-title">${ev.summary}</div>
                        <div class="task-time" style="color:${color}"><i class="far fa-clock"></i> ${timeStr}</div>
                    </div>`;
            });
        }

        function renderTaskList() {
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            if (myTasks.length === 0) { list.innerHTML = '<div style="text-align:center;color:#ccc;margin-top:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ Tasks</div>'; return; }
            myTasks.forEach(task => {
                let dueHtml = task.due ? `<div class="todo-due"><i class="fas fa-calendar-day"></i> ${new Date(task.due).toLocaleDateString('th-TH')}</div>` : '';
                list.innerHTML += `<div class="todo-item"><div class="todo-check"><i class="fas fa-check"></i></div><div class="todo-content"><div class="todo-title">${task.title}</div>${dueHtml}</div></div>`;
            });
        }

        // ==========================================
        // üïí ‡∏ß‡∏≤‡∏î‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤
        // ==========================================
        const ctx = document.getElementById('clock').getContext('2d');
        const cx = 500, cy = 500, r = 450;
        const angleOffset = -Math.PI / 2;

        function drawClock() {
            const now = new Date();
            document.getElementById('currentTime').innerText = now.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('currentDate').innerText = now.toLocaleDateString('th-TH', {weekday:'long', day:'numeric', month:'long'});

            ctx.clearRect(0, 0, 1000, 1000);
            
            ctx.beginPath(); ctx.arc(cx, cy, r, 0, 2*Math.PI); ctx.fillStyle='white'; ctx.fill();
            ctx.strokeStyle='#eee'; ctx.lineWidth=3; ctx.stroke();

            myEvents.forEach((ev, idx) => {
                if(!ev.start.dateTime) return;
                const start = new Date(ev.start.dateTime);
                const end = new Date(ev.end.dateTime);
                
                // ‡∏™‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                const color = ev.colorId ? '#4e54c8' : `hsl(${idx*60}, 60%, 60%)`;
                // ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ Contrast ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
                const textColor = getContrastColor(color);

                const startMin = (start.getHours() % 12) * 60 + start.getMinutes();
                const endMin = (end.getHours() % 12) * 60 + end.getMinutes();
                let sAng = (startMin / 720) * 2 * Math.PI + angleOffset;
                let eAng = (endMin / 720) * 2 * Math.PI + angleOffset;
                if (eAng < sAng) eAng += 2 * Math.PI;

                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°? (Active Pulse)
                const isActive = now >= start && now <= end;
                if (isActive) {
                    ctx.shadowColor = color; ctx.shadowBlur = 20; // ‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á
                } else {
                    ctx.shadowBlur = 0;
                }

                ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, sAng, eAng);
                ctx.fillStyle=color; ctx.globalAlpha=0.6; ctx.fill(); ctx.globalAlpha=1.0;
                ctx.shadowBlur = 0; // Reset shadow

                const durationMins = (end.getTime() - start.getTime()) / 60000;
                if (durationMins >= 60) {
                    const midAng = (sAng + eAng) / 2;
                    const textDist = r * 0.65;
                    const textX = cx + Math.cos(midAng) * textDist;
                    const textY = cy + Math.sin(midAng) * textDist;

                    ctx.save();
                    ctx.translate(textX, textY);
                    let rotateAng = midAng + Math.PI/2; 
                    if (midAng > Math.PI/2 && midAng < 3*Math.PI/2) rotateAng += Math.PI;
                    ctx.rotate(rotateAng);

                    ctx.textAlign = "center";
                    ctx.fillStyle = textColor; // üü¢ ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏≤ (‡∏Ç‡∏≤‡∏ß/‡∏î‡∏≥)
                    ctx.font = "bold 24px Prompt";
                    
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ö‡∏≤‡∏á‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏≠‡∏µ‡∏Å
                    ctx.strokeStyle = (textColor === '#ffffff') ? 'rgba(0,0,0,0.2)' : 'rgba(255,255,255,0.4)';
                    ctx.lineWidth = 3;
                    ctx.strokeText(ev.summary.length > 15 ? ev.summary.substring(0, 12)+"..." : ev.summary, 0, 0);
                    ctx.fillText(ev.summary.length > 15 ? ev.summary.substring(0, 12)+"..." : ev.summary, 0, 0);

                    ctx.restore();
                }
            });

            // ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
            ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.font = "bold 45px Prompt"; ctx.fillStyle = "#aaa";
            for(let i=1; i<=12; i++){
                const angle = (i/12) * 2 * Math.PI + angleOffset;
                ctx.beginPath(); 
                ctx.moveTo(cx+Math.cos(angle)*(r-20), cy+Math.sin(angle)*(r-20));
                ctx.lineTo(cx+Math.cos(angle)*r, cy+Math.sin(angle)*r);
                ctx.strokeStyle='#ddd'; ctx.lineWidth=5; ctx.stroke();
                const numX = cx + Math.cos(angle) * (r - 60);
                const numY = cy + Math.sin(angle) * (r - 60);
                ctx.fillText(i.toString(), numX, numY);
            }

            const curMin = (now.getHours() % 12) * 60 + now.getMinutes();
            const curAng = (curMin / 720) * 2 * Math.PI + angleOffset;
            ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, curAng, curAng);
            ctx.strokeStyle='#ff4757'; ctx.lineWidth=10; ctx.stroke();
            ctx.beginPath(); ctx.arc(cx+Math.cos(curAng)*r, cy+Math.sin(curAng)*r, 18, 0, 2*Math.PI);
            ctx.fillStyle='#ff4757'; ctx.fill();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.list-section').forEach(l => l.classList.remove('active'));
            if(tab === 'events') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('eventListSection').classList.add('active');
            } else {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('taskListSection').classList.add('active');
            }
        }
        function openModal() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('eventStart').value = now.toISOString().slice(0,16);
            now.setHours(now.getHours() + 1);
            document.getElementById('eventEnd').value = now.toISOString().slice(0,16);
            document.getElementById('eventModal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('eventModal').style.display = 'none'; }

        setInterval(drawClock, 1000);
        setInterval(fetchAllData, 300000);

    </script>
</body>
</html>
