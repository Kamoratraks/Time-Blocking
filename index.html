<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Sectograph (24H)</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }
        h1 { margin-bottom: 5px; font-size: 1.5rem; }
        #status { color: #666; font-size: 0.9rem; margin-bottom: 20px; height: 20px;}
        
        /* Clock Styling */
        .clock-wrapper {
            position: relative;
            width: 320px;
            height: 320px;
            margin: 0 auto 20px auto;
        }
        canvas {
            width: 100%;
            height: 100%;
            /* ‡∏´‡∏°‡∏∏‡∏ô Canvas ‡πÉ‡∏´‡πâ 0 ‡∏≠‡∏á‡∏®‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô (12 ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏Ç‡∏≠‡∏á‡∏ß‡∏á‡∏Å‡∏•‡∏°) */
            transform: rotate(-90deg); 
        }
        .center-display {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
        }
        .time-text { font-size: 2rem; font-weight: bold; color: #333; }
        .date-text { font-size: 0.8rem; color: #888; }

        /* Buttons */
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
        }
        #auth_btn { background-color: #4285F4; color: white; }
        #auth_btn:hover { background-color: #357ae8; }
        #signout_btn { background-color: #e74c3c; color: white; display: none; }
        
        .legend { font-size: 0.8rem; color: #777; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï 24 ‡∏ä‡∏°.</h1>
    <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ...</div>

    <div class="clock-wrapper">
        <canvas id="clockCanvas" width="600" height="600"></canvas>
        <div class="center-display">
            <div class="time-text" id="digitalTime">--:--</div>
            <div class="date-text" id="digitalDate">--/--/----</div>
        </div>
    </div>

    <div>
        <button id="auth_btn" onclick="handleAuthClick()">Connect Google Calendar</button>
        <button id="signout_btn" onclick="handleSignoutClick()">Sign Out</button>
    </div>
    <div class="legend">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏ß‡∏±‡∏ô = ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)</div>
</div>

<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

<script>
    /* ================= CONFIGURATION ================= */
    // ‡πÉ‡∏™‡πà Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    const CLIENT_ID = '403729551714-j8jksjp2uqoauhc7bi2ibh02bpnvtvbh.apps.googleusercontent.com'; 
    const API_KEY = 'AIzaSyC9B9m47khLErMibHa0Fjc29B2xxE8Osoo'; 
    
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/calendar.events.readonly';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let myEvents = []; // ‡πÄ‡∏Å‡πá‡∏ö Event ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤

    /* ================= AUTHENTICATION ================= */
    function gapiLoaded() {
        gapi.load('client', async () => {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            checkAuthButtons();
        });
    }

    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '', // defined later
        });
        gisInited = true;
        checkAuthButtons();
    }

    function checkAuthButtons() {
        if (gapiInited && gisInited) {
            document.getElementById('status').innerText = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
        }
    }

    function handleAuthClick() {
        tokenClient.callback = async (resp) => {
            if (resp.error) throw resp;
            document.getElementById('auth_btn').style.display = 'none';
            document.getElementById('signout_btn').style.display = 'inline-block';
            document.getElementById('status').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            await fetchEvents();
        };

        if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
            tokenClient.requestAccessToken({prompt: ''});
        }
    }

    function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
            google.accounts.oauth2.revoke(token.access_token);
            gapi.client.setToken('');
            document.getElementById('auth_btn').style.display = 'inline-block';
            document.getElementById('signout_btn').style.display = 'none';
            document.getElementById('status').innerText = '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
            myEvents = []; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            drawClock(); // ‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏ö‡∏ö‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤)
        }
    }

    /* ================= API FETCHING ================= */
    async function fetchEvents() {
        const now = new Date();
        const startOfDay = new Date(now.setHours(0,0,0,0)).toISOString();
        const endOfDay = new Date(now.setHours(23,59,59,999)).toISOString();

        try {
            const request = {
                'calendarId': 'primary',
                'timeMin': startOfDay,
                'timeMax': endOfDay,
                'showDeleted': false,
                'singleEvents': true,
                'orderBy': 'startTime',
            };
            const response = await gapi.client.calendar.events.list(request);
            myEvents = response.result.items;
            document.getElementById('status').innerText = `‡∏ã‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß: ‡∏û‡∏ö ${myEvents.length} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°`;
            drawClock();
        } catch (err) {
            document.getElementById('status').innerText = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            console.error(err);
        }
    }

    /* ================= CLOCK DRAWING LOGIC (CANVAS) ================= */
    const canvas = document.getElementById('clockCanvas');
    const ctx = canvas.getContext('2d');
    const cx = canvas.width / 2;
    const cy = canvas.height / 2;
    const radius = 250; // ‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ß‡∏á‡∏Å‡∏•‡∏°

    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Date Object) ‡πÄ‡∏õ‡πá‡∏ô ‡∏≠‡∏á‡∏®‡∏≤ (Radians) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏î 24 ‡∏ä‡∏°.
    // 00:00 = 0 ‡∏≠‡∏á‡∏®‡∏≤, 12:00 = 180 ‡∏≠‡∏á‡∏®‡∏≤ (PI), 24:00 = 360 ‡∏≠‡∏á‡∏®‡∏≤ (2PI)
    function timeToAngle24(date) {
        const h = date.getHours();
        const m = date.getMinutes();
        const totalMinutes = (h * 60) + m;
        // 1 ‡∏ß‡∏±‡∏ô = 1440 ‡∏ô‡∏≤‡∏ó‡∏µ = 2 * PI
        return (totalMinutes / 1440) * (2 * Math.PI);
    }

    function drawClock() {
        // 1. Clear Canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 2. ‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏î
        ctx.beginPath();
        ctx.arc(cx, cy, radius, 0, 2 * Math.PI);
        ctx.fillStyle = '#ecf0f1';
        ctx.fill();
        ctx.strokeStyle = '#bdc3c7';
        ctx.lineWidth = 2;
        ctx.stroke();

        // 3. ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (24 ‡πÄ‡∏™‡πâ‡∏ô)
        for (let i = 0; i < 24; i++) {
            const angle = (i / 24) * (2 * Math.PI);
            const x1 = cx + Math.cos(angle) * (radius - 20);
            const y1 = cy + Math.sin(angle) * (radius - 20);
            const x2 = cx + Math.cos(angle) * radius;
            const y2 = cy + Math.sin(angle) * radius;
            
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.strokeStyle = '#95a5a6';
            ctx.lineWidth = i % 6 === 0 ? 4 : 1; // ‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏ô‡∏≤‡∏ó‡∏∏‡∏Å 6 ‡∏ä‡∏°.
            ctx.stroke();
        }

        // 4. ‡∏ß‡∏≤‡∏î Event Segments (‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏Ñ‡πâ‡∏Å)
        if (myEvents && myEvents.length > 0) {
            myEvents.forEach(event => {
                if(!event.start.dateTime) return; // ‡∏Ç‡πâ‡∏≤‡∏° event ‡πÅ‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô (All Day)

                const start = new Date(event.start.dateTime);
                const end = new Date(event.end.dateTime);
                
                let startAngle = timeToAngle24(start);
                let endAngle = timeToAngle24(end);

                // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô (‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏ö‡∏ó‡∏µ‡πà 24.00)
                if (endAngle < startAngle) endAngle = 2 * Math.PI;

                ctx.beginPath();
                ctx.moveTo(cx, cy); // ‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á
                ctx.arc(cx, cy, radius, startAngle, endAngle);
                ctx.closePath();
                
                // ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏à‡∏≤‡∏Å Google (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏∏‡πà‡∏°
                ctx.fillStyle = event.colorId ? '#3498db' : 'rgba(52, 152, 219, 0.6)'; 
                ctx.fill();
                
                // ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏≤‡∏ß‡πÅ‡∏¢‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
            });
        }

        // 5. ‡∏ß‡∏≤‡∏î‡πÄ‡∏Ç‡πá‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Current Time Indicator)
        const now = new Date();
        const nowAngle = timeToAngle24(now);

        ctx.beginPath();
        ctx.moveTo(cx, cy);
        const handLen = radius + 10;
        const hx = cx + Math.cos(nowAngle) * handLen;
        const hy = cy + Math.sin(nowAngle) * handLen;
        
        ctx.lineTo(hx, hy);
        ctx.strokeStyle = '#e74c3c'; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
        ctx.lineWidth = 4;
        ctx.stroke();

        // ‡∏à‡∏∏‡∏î‡πÅ‡∏î‡∏á‡∏ï‡∏£‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏Ç‡πá‡∏°
        ctx.beginPath();
        ctx.arc(hx, hy, 6, 0, 2*Math.PI);
        ctx.fillStyle = '#e74c3c';
        ctx.fill();

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á
        document.getElementById('digitalTime').innerText = 
            now.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
        document.getElementById('digitalDate').innerText = 
            now.toLocaleDateString('th-TH');
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô Loop ‡∏ß‡∏≤‡∏î‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    setInterval(drawClock, 1000);
    drawClock(); // ‡∏ß‡∏≤‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

</script>

</body>
</html>
