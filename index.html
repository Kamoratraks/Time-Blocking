<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Pro Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #4e54c8;
            --secondary: #8f94fb;
            --task-color: #ff6b6b;
            --bg: #f4f7fc;
            --card-bg: #ffffff;
            --text-main: #333;
            --text-muted: #888;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        body {
            font-family: 'Prompt', sans-serif;
            background: var(--bg);
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* --- Layout --- */
        .app-container {
            width: 90%;
            max-width: 1100px;
            height: 85vh;
            background: var(--card-bg);
            border-radius: 30px;
            box-shadow: var(--shadow);
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* --- Sidebar (Left) --- */
        .sidebar {
            width: 380px;
            background: #fafbff;
            border-right: 1px solid #eee;
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .header { margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .header p { margin: 5px 0 0; color: var(--text-muted); font-size: 0.9rem; }

        /* --- Tabs --- */
        .tabs {
            display: flex;
            background: #eef2f7;
            padding: 5px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Prompt';
            font-weight: 500;
            transition: 0.3s;
        }
        .tab-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-weight: 600;
        }

        /* --- Lists --- */
        .list-container {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 5px;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .list-container.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Items --- */
        .task-item {
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            border-left: 5px solid #ddd;
            transition: 0.2s;
            cursor: default;
        }
        .task-time { font-size: 0.8rem; color: var(--text-muted); font-weight: 600; }
        .task-title { font-size: 1rem; margin-top: 3px; font-weight: 500; }

        .todo-item {
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            display: flex; align-items: center; gap: 12px;
            border-left: 5px solid var(--task-color);
        }
        .todo-check {
            width: 22px; height: 22px; border: 2px solid #ddd; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 12px;
        }
        .todo-content { flex-grow: 1; }
        .todo-title { font-size: 0.95rem; font-weight: 500; color: #444; }
        .todo-due { font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }

        /* --- Main Content (Clock) --- */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: radial-gradient(circle at center, #ffffff 0%, #f8f9fa 100%);
        }
        .clock-wrapper { position: relative; width: 450px; height: 450px; }
        canvas { width: 100%; height: 100%; transform: rotate(-90deg); }
        .center-info {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none;
        }
        .time-big { font-size: 3.5rem; font-weight: 600; color: var(--primary); margin: 0; line-height: 1;}
        .date-small { font-size: 1rem; color: #999; margin-top: 5px; }

        /* --- Buttons --- */
        .btn-login {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white; border: none; padding: 12px; border-radius: 12px;
            cursor: pointer; font-family: inherit; font-weight: 600;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; margin-bottom: 20px; transition: 0.3s;
        }
        .btn-logout { background: #ff6b6b; margin-top: 20px; }
        .fab {
            position: absolute; bottom: 30px; right: 30px;
            width: 60px; height: 60px; background: var(--primary); color: white;
            border-radius: 50%; border: none; font-size: 24px; cursor: pointer;
            box-shadow: 0 10px 20px rgba(78, 84, 200, 0.4); display: none;
        }

        /* --- Modal --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 20px; width: 350px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; font-family: 'Prompt'; }
        .btn-save { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; }
        .close-modal { float: right; cursor: pointer; color: #999; }

        @media (max-width: 768px) {
            .app-container { flex-direction: column-reverse; height: 95vh; }
            .sidebar { width: 100%; height: auto; min-height: 400px; padding: 20px; box-sizing: border-box;}
            .main-content { min-height: 400px; }
            .clock-wrapper { width: 300px; height: 300px; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="sidebar">
            <div class="header">
                <h1>My Planner</h1>
                <p id="user-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>

            <button id="authBtn" class="btn-login" onclick="handleAuth()">
                <i class="fab fa-google"></i> ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google
            </button>

            <div class="tabs" id="tabContainer" style="display:none;">
                <button class="tab-btn active" onclick="switchTab('events')">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</button>
                <button class="tab-btn" onclick="switchTab('tasks')">Tasks</button>
            </div>

            <div class="list-container active" id="eventList">
                <div style="text-align:center; color:#ccc; margin-top:50px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
            </div>
            <div class="list-container" id="taskList">
                <div style="text-align:center; color:#ccc; margin-top:50px;">‡πÑ‡∏°‡πà‡∏°‡∏µ Tasks</div>
            </div>

            <button id="logoutBtn" class="btn-login btn-logout" onclick="handleSignout()" style="display:none;">
                ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>

        <div class="main-content">
            <div class="clock-wrapper">
                <canvas id="clock" width="900" height="900"></canvas>
                <div class="center-info">
                    <h1 class="time-big" id="currentTime">--:--</h1>
                    <div class="date-small" id="currentDate">...</div>
                </div>
            </div>
            <button class="fab" id="addBtn" onclick="openModal()">+</button>
        </div>
    </div>

    <div class="modal" id="eventModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 style="margin-top:0;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà</h2>
            <input type="text" id="eventTitle" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">
            <label>‡πÄ‡∏£‡∏¥‡πà‡∏°:</label> <input type="datetime-local" id="eventStart" class="form-control">
            <label>‡∏à‡∏ö:</label> <input type="datetime-local" id="eventEnd" class="form-control">
            <button class="btn-save" onclick="saveEvent()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
        </div>
    </div>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        // ==========================================
        // üîê ‡πÉ‡∏™‡πà KEY ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏∑‡∏°!)
        // ==========================================
        const CLIENT_ID = '403729551714-j8jksjp2uqoauhc7bi2ibh02bpnvtvbh.apps.googleusercontent.com'; 
        const API_KEY = 'AIzaSyC9B9m47khLErMibHa0Fjc29B2xxE8Osoo';
        // ==========================================

        // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ API ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Array ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
        const DISCOVERY_DOCS = [
            'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
            'https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest'
        ];
        
        // ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ (Calendar + Tasks)
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/tasks'; 

        let tokenClient, gapiInited = false, gisInited = false;
        let myEvents = [], myTasks = [];

        // 1. ‡πÇ‡∏´‡∏•‡∏î GAPI
        function gapiLoaded() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: DISCOVERY_DOCS, // ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å
                });
                gapiInited = true; checkAutoLogin();
            });
        }

        // 2. ‡πÇ‡∏´‡∏•‡∏î GIS
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES, callback: '', 
            });
            gisInited = true; checkAutoLogin();
        }

        // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Login
        function checkAutoLogin() {
            const savedToken = localStorage.getItem('g_token');
            if (savedToken && gapiInited && gisInited) {
                try {
                    gapi.client.setToken(JSON.parse(savedToken));
                    toggleState(true);
                    fetchAllData();
                } catch(e) { console.log("Token error"); }
            } else {
                toggleState(false);
            }
        }

        // 4. ‡∏õ‡∏∏‡πà‡∏° Login
        function handleAuth() {
            tokenClient.callback = async (resp) => {
                if (resp.error) throw resp;
                localStorage.setItem('g_token', JSON.stringify(gapi.client.getToken()));
                toggleState(true);
                await fetchAllData();
            };
            if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'});
            else tokenClient.requestAccessToken({prompt: ''});
        }

        // 5. ‡∏õ‡∏∏‡πà‡∏° Logout
        function handleSignout() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                localStorage.removeItem('g_token');
            }
            toggleState(false);
            myEvents = []; myTasks = [];
            drawClock(); renderLists();
        }

        function toggleState(isLoggedIn) {
            const authBtn = document.getElementById('authBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const addBtn = document.getElementById('addBtn');
            const userStatus = document.getElementById('user-status');
            const tabContainer = document.getElementById('tabContainer');

            if (isLoggedIn) {
                authBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                addBtn.style.display = 'block';
                tabContainer.style.display = 'flex';
                userStatus.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...";
                userStatus.style.color = "green";
            } else {
                authBtn.style.display = 'flex';
                logoutBtn.style.display = 'none';
                addBtn.style.display = 'none';
                tabContainer.style.display = 'none';
                userStatus.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google";
                userStatus.style.color = "#888";
            }
        }

        // 6. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        async function fetchAllData() {
            await fetchEvents();
            await fetchTasks();
            document.getElementById('user-status').innerText = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: " + new Date().toLocaleTimeString('th-TH');
        }

        async function fetchEvents() {
            try {
                const now = new Date();
                const startOfDay = new Date(now.setHours(0,0,0,0)).toISOString();
                const endOfDay = new Date(now.setHours(23,59,59,999)).toISOString();

                const response = await gapi.client.calendar.events.list({
                    'calendarId': 'primary', 'timeMin': startOfDay, 'timeMax': endOfDay,
                    'showDeleted': false, 'singleEvents': true, 'orderBy': 'startTime'
                });
                myEvents = response.result.items;
                renderLists(); drawClock();
            } catch (err) { console.error(err); if(err.status===401) handleSignout(); }
        }

        async function fetchTasks() {
            try {
                const response = await gapi.client.tasks.tasks.list({
                    'tasklist': '@default', 'showCompleted': false, 'maxResults': 20
                });
                myTasks = response.result.items || [];
                renderLists();
            } catch (err) { console.error(err); }
        }

        // 7. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô
        async function saveEvent() {
            const summary = document.getElementById('eventTitle').value;
            const startVal = document.getElementById('eventStart').value;
            const endVal = document.getElementById('eventEnd').value;
            if(!summary || !startVal || !endVal) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

            const event = {
                'summary': summary,
                'start': { 'dateTime': new Date(startVal).toISOString() },
                'end': { 'dateTime': new Date(endVal).toISOString() }
            };

            try {
                await gapi.client.calendar.events.insert({ 'calendarId': 'primary', 'resource': event });
                closeModal(); alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!"); fetchAllData();
            } catch (err) { alert("Error: " + err.message); }
        }

        // 8. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• UI
        function renderLists() {
            // Render Events
            const eventList = document.getElementById('eventList');
            eventList.innerHTML = '';
            if (myEvents.length === 0) eventList.innerHTML = '<div style="text-align:center;color:#ccc;margin-top:20px;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤</div>';
            
            myEvents.forEach((ev, idx) => {
                if (!ev.start.dateTime) return; // ‡∏Ç‡πâ‡∏≤‡∏° All-day
                const start = new Date(ev.start.dateTime);
                const end = new Date(ev.end.dateTime);
                const color = ev.colorId ? '#4e54c8' : `hsl(${idx*50}, 60%, 60%)`;
                
                eventList.innerHTML += `
                    <div class="task-item" style="border-left-color:${color}">
                        <div class="task-time" style="color:${color}">
                            ${start.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})} - 
                            ${end.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})}
                        </div>
                        <div class="task-title">${ev.summary}</div>
                    </div>`;
            });

            // Render Tasks
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            if (myTasks.length === 0) taskList.innerHTML = '<div style="text-align:center;color:#ccc;margin-top:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ Tasks ‡∏Ñ‡πâ‡∏≤‡∏á</div>';

            myTasks.forEach(task => {
                let dueHtml = task.due ? `<div class="todo-due"><i class="far fa-clock"></i> ${new Date(task.due).toLocaleDateString('th-TH')}</div>` : '';
                taskList.innerHTML += `
                    <div class="todo-item">
                        <div class="todo-check"><i class="fas fa-check"></i></div>
                        <div class="todo-content">
                            <div class="todo-title">${task.title}</div>
                            ${dueHtml}
                        </div>
                    </div>`;
            });
        }

        // 9. ‡∏ß‡∏≤‡∏î‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤
        const ctx = document.getElementById('clock').getContext('2d');
        const cx = 450, cy = 450, r = 400;

        function drawClock() {
            const now = new Date();
            document.getElementById('currentTime').innerText = now.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('currentDate').innerText = now.toLocaleDateString('th-TH', {weekday:'long', day:'numeric', month:'long'});

            ctx.clearRect(0, 0, 900, 900);
            
            // Background
            ctx.beginPath(); ctx.arc(cx, cy, r, 0, 2*Math.PI); ctx.fillStyle='white'; ctx.fill();
            ctx.strokeStyle='#eee'; ctx.lineWidth=2; ctx.stroke();

            // Events
            myEvents.forEach((ev, idx) => {
                if(!ev.start.dateTime) return;
                const start = new Date(ev.start.dateTime);
                const end = new Date(ev.end.dateTime);
                const color = ev.colorId ? '#4e54c8' : `hsl(${idx*50}, 60%, 60%)`;

                const startMin = (start.getHours()%12)*60 + start.getMinutes();
                const endMin = (end.getHours()%12)*60 + end.getMinutes();
                let sAng = (startMin/720)*2*Math.PI;
                let eAng = (endMin/720)*2*Math.PI;
                if(eAng < sAng) eAng += 2*Math.PI;

                ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, sAng, eAng);
                ctx.fillStyle=color; ctx.globalAlpha=0.6; ctx.fill(); ctx.globalAlpha=1.0;
            });

            // Hands
            const curMin = (now.getHours()%12)*60 + now.getMinutes();
            const curAng = (curMin/720)*2*Math.PI;
            
            // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ö‡∏≠‡∏Å‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
            for(let i=0; i<12; i++){
                const a = (i/12)*2*Math.PI;
                ctx.beginPath(); ctx.moveTo(cx+Math.cos(a)*(r-20), cy+Math.sin(a)*(r-20));
                ctx.lineTo(cx+Math.cos(a)*r, cy+Math.sin(a)*r);
                ctx.strokeStyle='#ddd'; ctx.lineWidth=4; ctx.stroke();
            }

            ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, curAng, curAng);
            ctx.strokeStyle='#ff4757'; ctx.lineWidth=8; ctx.stroke();
            ctx.beginPath(); ctx.arc(cx+Math.cos(curAng)*r, cy+Math.sin(curAng)*r, 15, 0, 2*Math.PI);
            ctx.fillStyle='#ff4757'; ctx.fill();
        }

        // Helpers
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.list-container').forEach(l => l.classList.remove('active'));
            if(tab === 'events') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('eventList').classList.add('active');
            } else {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('taskList').classList.add('active');
            }
        }
        function openModal() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('eventStart').value = now.toISOString().slice(0,16);
            now.setHours(now.getHours() + 1);
            document.getElementById('eventEnd').value = now.toISOString().slice(0,16);
            document.getElementById('eventModal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('eventModal').style.display = 'none'; }

        setInterval(drawClock, 1000);
        setInterval(fetchAllData, 300000);

    </script>
</body>
</html>
