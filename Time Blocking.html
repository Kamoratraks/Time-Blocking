<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Cal Sectograph</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4285F4; --bg: #f8f9fa; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        
        /* Clock Style */
        .clock-wrapper { position: relative; width: 300px; height: 300px; margin: 20px auto; }
        canvas { transform: rotate(-90deg); width: 100%; height: 100%; }
        .center-info { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; width: 90px; height: 90px; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* Buttons */
        .btn-google { background: #4285F4; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 10px; display: inline-flex; align-items: center; gap: 8px; }
        .btn-google:hover { background: #357ae8; }
        .hidden { display: none; }
        
        /* List */
        .event-list { text-align: left; margin-top: 20px; }
        .event-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9em; display: flex; align-items: center; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <h2>üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
        
        <button id="authorize_button" class="btn-google" onclick="handleAuthClick()">
            üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Calendar
        </button>
        <button id="signout_button" class="btn-google hidden" onclick="handleSignoutClick()">
            ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        </button>

        <div class="clock-wrapper">
            <canvas id="chartCanvas" width="300" height="300"></canvas>
            <div class="center-info">
                <strong id="time-display" style="font-size:1.2em;">--:--</strong>
                <small id="date-display" style="font-size:0.7em; color:#666;">...</small>
            </div>
        </div>

        <div class="event-list" id="content">
            <p style="text-align:center; color:#888;">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        // ==========================================
        // üî¥ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!) üî¥
        // ==========================================
        const CLIENT_ID = '403729551714-j8jksjp2uqoauhc7bi2ibh02bpnvtvbh.apps.googleusercontent.com'; // ‡πÉ‡∏™‡πà Client ID ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Google
        const API_KEY = 'AIzaSyC9B9m47khLErMibHa0Fjc29B2xxE8Osoo';     // ‡πÉ‡∏™‡πà API Key ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Google
        // ==========================================

        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events.readonly';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        function gapiLoaded() {
            gapi.load('client', intializeGapiClient);
        }

        async function intializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('authorize_button').style.display = 'inline-flex';
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error) throw resp;
                document.getElementById('authorize_button').classList.add('hidden');
                document.getElementById('signout_button').classList.remove('hidden');
                await listUpcomingEvents();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('content').innerHTML = '<p style="text-align:center;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß</p>';
                document.getElementById('authorize_button').classList.remove('hidden');
                document.getElementById('signout_button').classList.add('hidden');
                clearCanvas();
            }
        }

        async function listUpcomingEvents() {
            const now = new Date();
            const startOfDay = new Date(now.setHours(0,0,0,0)).toISOString();
            const endOfDay = new Date(now.setHours(23,59,59,999)).toISOString();

            try {
                const request = {
                    'calendarId': 'primary',
                    'timeMin': startOfDay,
                    'timeMax': endOfDay,
                    'showDeleted': false,
                    'singleEvents': true,
                    'orderBy': 'startTime',
                };
                const response = await gapi.client.calendar.events.list(request);
                const events = response.result.items;

                const content = document.getElementById('content');
                content.innerHTML = '';
                
                if (!events || events.length === 0) {
                    content.innerText = '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
                    clearCanvas();
                    return;
                }

                const tasksForClock = [];

                events.forEach(event => {
                    const when = event.start.dateTime;
                    const endWhen = event.end.dateTime;
                    if (!when) return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏û‡∏ß‡∏Å All day event ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô

                    const start = new Date(when);
                    const end = new Date(endWhen);
                    const timeStr = start.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
                    
                    // ‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏µ (‡∏ñ‡πâ‡∏≤ Google ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏™‡∏µ‡∏°‡∏≤ ‡πÉ‡∏´‡πâ‡∏™‡∏∏‡πà‡∏°)
                    const color = event.colorId ? '#4285F4' : '#'+Math.floor(Math.random()*16777215).toString(16);

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ text
                    const div = document.createElement('div');
                    div.className = 'event-item';
                    div.innerHTML = `<div class="dot" style="background:${color}"></div> 
                                     <strong>${timeStr}</strong> &nbsp; ${event.summary}`;
                    content.appendChild(div);

                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü
                    tasksForClock.push({ start, end, color });
                });

                drawClock(tasksForClock);

            } catch (err) {
                document.getElementById('content').innerText = err.message;
            }
        }

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ß‡∏≤‡∏î‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
        function clearCanvas() {
            const canvas = document.getElementById('chartCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0,0, canvas.width, canvas.height);
        }

        function drawClock(tasks) {
            const canvas = document.getElementById('chartCanvas');
            const ctx = canvas.getContext('2d');
            const cx = canvas.width/2, cy = canvas.height/2, r = 140;
            
            ctx.clearRect(0,0, canvas.width, canvas.height);

            // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
            ctx.beginPath(); ctx.arc(cx, cy, r, 0, 2*Math.PI);
            ctx.fillStyle = '#eee'; ctx.fill();

            // ‡∏ß‡∏≤‡∏î Events
            tasks.forEach(t => {
                const startH = t.start.getHours() + t.start.getMinutes()/60;
                const endH = t.end.getHours() + t.end.getMinutes()/60;
                
                // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∏‡∏° (12 ‡∏ä‡∏°)
                const sAngle = ((startH % 12) / 12) * 2 * Math.PI;
                let eAngle = ((endH % 12) / 12) * 2 * Math.PI;
                
                if (eAngle < sAngle) eAngle += 2*Math.PI; // ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏ß‡∏±‡∏ô/‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô

                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.arc(cx, cy, r, sAngle, eAngle);
                ctx.fillStyle = t.color;
                ctx.fill();
            });

            // ‡∏ß‡∏≤‡∏î‡πÄ‡∏Ç‡πá‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            updateRealTime();
        }

        function updateRealTime() {
            const now = new Date();
            document.getElementById('time-display').innerText = now.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('date-display').innerText = now.toLocaleDateString('th-TH');
            
            // ‡∏ß‡∏≤‡∏î‡πÄ‡∏Ç‡πá‡∏°‡πÅ‡∏î‡∏á
            const canvas = document.getElementById('chartCanvas');
            const ctx = canvas.getContext('2d');
            const cx = canvas.width/2, cy = canvas.height/2, r = 140;
            
            const h = now.getHours() % 12;
            const m = now.getMinutes();
            const angle = ((h + m/60)/12) * 2 * Math.PI;

            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.arc(cx, cy, r, angle-0.02, angle+0.02);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 3;
            ctx.stroke();
        }
        setInterval(updateRealTime, 1000);
    </script>
</body>
</html>
